#!/usr/bin/expect -f

set timeout 30
set password "LEJ6U5chSK"
set host "root@37.1.212.51"

puts "ðŸ”§ Restoring correct Xray config..."

spawn ssh -o StrictHostKeyChecking=no $host
expect "password:"
send "$password\r"
expect "#"

# The issue: "name" field in fallbacks is invalid for Xray
# Correct fallback format doesn't use "name" - it uses "alpn" or no field at all
# We'll restore a simple, working config without complex fallbacks

puts "ðŸ“ Writing correct Xray config..."
send "cat > /var/lib/marzban/xray_config.json << 'XRAYEOF'
{
  \"log\": {
    \"loglevel\": \"warning\"
  },
  \"inbounds\": \[
    {
      \"tag\": \"VLESS_IN\",
      \"listen\": \"0.0.0.0\",
      \"port\": 443,
      \"protocol\": \"vless\",
      \"settings\": {
        \"clients\": \[
          {
            \"id\": \"eb4a1cf2-4235-4b0a-83b2-0e5a298389ed\",
            \"flow\": \"xtls-rprx-vision\",
            \"email\": \"vera\"
          }
        \],
        \"decryption\": \"none\",
        \"fallbacks\": \[
          {
            \"dest\": \"taxi.yandex.ru:443\",
            \"xver\": 0
          }
        \]
      },
      \"streamSettings\": {
        \"network\": \"tcp\",
        \"security\": \"reality\",
        \"realitySettings\": {
          \"show\": false,
          \"dest\": \"taxi.yandex.ru:443\",
          \"xver\": 0,
          \"serverNames\": \[
            \"taxi.yandex.ru\",
            \"ya.ru\",
            \"yandex.ru\"
          \],
          \"privateKey\": \"4PjME9JBUmV-Td9rZGS9l0147TXqMJtcU_f2iG-PVxA\",
          \"shortIds\": \[
            \"\"
          \]
        }
      },
      \"sniffing\": {
        \"enabled\": true,
        \"destOverride\": \[\"http\", \"tls\"\]
      }
    }
  \],
  \"outbounds\": \[
    {
      \"protocol\": \"freedom\",
      \"tag\": \"DIRECT\"
    },
    {
      \"protocol\": \"blackhole\",
      \"tag\": \"BLOCK\"
    }
  \],
  \"routing\": {
    \"rules\": \[
      {
        \"type\": \"field\",
        \"ip\": \[
          \"geoip:private\"
        \],
        \"outboundTag\": \"DIRECT\"
      }
    \]
  }
}
XRAYEOF
\r"
expect "#"

puts "ðŸ”„ Restarting Marzban..."
send "cd /var/lib/marzban && docker compose restart\r"
expect {
    "Container marzban" { }
    timeout { puts "Restart taking time..." }
}
expect "#"

puts "âœ… Done!"
send "exit\r"
expect eof
