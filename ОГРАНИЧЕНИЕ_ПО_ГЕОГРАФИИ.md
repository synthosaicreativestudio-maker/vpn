# üåç –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–∞ –ø–æ –≥–µ–æ–≥—Ä–∞—Ñ–∏–∏ —Å –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞–º–∏

**–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ TinyProxy: –Ø–Ω–¥–µ–∫—Å ‚Üí –¢—é–º–µ–Ω—å ‚Üí –£–ª—å—è–Ω–æ–≤—Å–∫ ‚Üí –†–§ ‚Üí –º–∞–∫—Å–∏–º—É–º 20 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π**

---

## üéØ –¶–µ–ª—å

–û–≥—Ä–∞–Ω–∏—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –ø—Ä–æ–∫—Å–∏ (–ø–æ—Ä—Ç 8080) –ø–æ –≥–µ–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–æ–º—É –ø—Ä–∏–Ω—Ü–∏–ø—É:
1. **–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 1:** IP –∞–¥—Ä–µ—Å–∞ –Ø–Ω–¥–µ–∫—Å–∞
2. **–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 2:** –¢—é–º–µ–Ω—å (–†–§)
3. **–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 3:** –£–ª—å—è–Ω–æ–≤—Å–∫ (–†–§)
4. **–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 4:** –í—Å—è –†–§
5. **–ú–∞–∫—Å–∏–º—É–º:** 20 –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π

---

## üìã –í–∞—Ä–∏–∞–Ω—Ç—ã —Ä–µ—à–µ–Ω–∏—è

### –í–∞—Ä–∏–∞–Ω—Ç 1: –ü—Ä–æ—Å—Ç–æ–π (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è) - —á–µ—Ä–µ–∑ IP —Å–ø–∏—Å–∫–∏
**–ü–ª—é—Å—ã:** –ü—Ä–æ—Å—Ç–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å, –±—ã—Å—Ç—Ä–æ —Ä–∞–±–æ—Ç–∞–µ—Ç  
**–ú–∏–Ω—É—Å—ã:** –ù—É–∂–Ω–æ –æ–±–Ω–æ–≤–ª—è—Ç—å —Å–ø–∏—Å–∫–∏ IP –≤—Ä—É—á–Ω—É—é

### –í–∞—Ä–∏–∞–Ω—Ç 2: –ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π - —á–µ—Ä–µ–∑ GeoIP –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
**–ü–ª—é—Å—ã:** –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ IP, —Ç–æ—á–Ω–µ–µ  
**–ú–∏–Ω—É—Å—ã:** –°–ª–æ–∂–Ω–µ–µ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å, —Ç—Ä–µ–±—É–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –±–∞–∑

---

## ‚úÖ –í–ê–†–ò–ê–ù–¢ 1: –ü—Ä–æ—Å—Ç–æ–π (—á–µ—Ä–µ–∑ IP —Å–ø–∏—Å–∫–∏)

### –®–ê–ì 1: –ü–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å —Å–ø–∏—Å–∫–∏ IP –∞–¥—Ä–µ—Å–æ–≤

#### 1.1. IP –∞–¥—Ä–µ—Å–∞ –Ø–Ω–¥–µ–∫—Å–∞ (–æ—Å–Ω–æ–≤–Ω—ã–µ –¥–∏–∞–ø–∞–∑–æ–Ω—ã)

–°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª —Å IP –Ø–Ω–¥–µ–∫—Å–∞:
```bash
cat > /etc/tinyproxy/yandex_ips.txt << 'EOF'
# –û—Å–Ω–æ–≤–Ω—ã–µ IP –¥–∏–∞–ø–∞–∑–æ–Ω—ã –Ø–Ω–¥–µ–∫—Å–∞
5.45.192.0/18
5.45.250.0/23
37.9.64.0/18
37.140.128.0/18
77.88.0.0/18
87.250.224.0/19
93.158.134.0/24
95.163.0.0/16
141.8.128.0/18
178.154.128.0/17
185.32.248.0/22
213.180.192.0/19
EOF
```

#### 1.2. IP –¥–∏–∞–ø–∞–∑–æ–Ω—ã –¥–ª—è –¢—é–º–µ–Ω–∏

**–ö–∞–∫ —É–∑–Ω–∞—Ç—å IP –¢—é–º–µ–Ω–∏:**
1. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å–µ—Ä–≤–∏—Å—ã —Ç–∏–ø–∞ https://ipgeolocation.io
2. –ò–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ GeoIP –±–∞–∑—ã (—Å–º. –í–∞—Ä–∏–∞–Ω—Ç 2)

**–ü—Ä–∏–º–µ—Ä (–Ω—É–∂–Ω–æ —É—Ç–æ—á–Ω–∏—Ç—å –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ IP):**
```bash
cat > /etc/tinyproxy/tyumen_ips.txt << 'EOF'
# IP –¥–∏–∞–ø–∞–∑–æ–Ω—ã –¢—é–º–µ–Ω–∏ (–ø—Ä–∏–º–µ—Ä, –Ω—É–∂–Ω–æ —É—Ç–æ—á–Ω–∏—Ç—å)
# –î–æ–±–∞–≤—å—Ç–µ –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ IP –¥–∏–∞–ø–∞–∑–æ–Ω—ã –¥–ª—è –¢—é–º–µ–Ω–∏
EOF
```

#### 1.3. IP –¥–∏–∞–ø–∞–∑–æ–Ω—ã –¥–ª—è –£–ª—å—è–Ω–æ–≤—Å–∫–∞

**–ü—Ä–∏–º–µ—Ä (–Ω—É–∂–Ω–æ —É—Ç–æ—á–Ω–∏—Ç—å –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ IP):**
```bash
cat > /etc/tinyproxy/ulyanovsk_ips.txt << 'EOF'
# IP –¥–∏–∞–ø–∞–∑–æ–Ω—ã –£–ª—å—è–Ω–æ–≤—Å–∫–∞ (–ø—Ä–∏–º–µ—Ä, –Ω—É–∂–Ω–æ —É—Ç–æ—á–Ω–∏—Ç—å)
# –î–æ–±–∞–≤—å—Ç–µ –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ IP –¥–∏–∞–ø–∞–∑–æ–Ω—ã –¥–ª—è –£–ª—å—è–Ω–æ–≤—Å–∫–∞
EOF
```

---

### –®–ê–ì 2: –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –ø—Ä–∞–≤–∏–ª–∞ UFW —Å –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞–º–∏

**–í–∞–∂–Ω–æ:** UFW –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –ø—Ä–∞–≤–∏–ª–∞ –ø–æ –ø–æ—Ä—è–¥–∫—É, –ø–µ—Ä–≤–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è.

```bash
# 1. –†–∞–∑—Ä–µ—à–∏—Ç—å –Ø–Ω–¥–µ–∫—Å (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç 1)
while read ip; do
    [[ "$ip" =~ ^# ]] && continue
    ufw allow from $ip to any port 8080 proto tcp comment "Yandex IP"
done < /etc/tinyproxy/yandex_ips.txt

# 2. –†–∞–∑—Ä–µ—à–∏—Ç—å –¢—é–º–µ–Ω—å (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç 2)
while read ip; do
    [[ "$ip" =~ ^# ]] && continue
    ufw allow from $ip to any port 8080 proto tcp comment "Tyumen IP"
done < /etc/tinyproxy/tyumen_ips.txt

# 3. –†–∞–∑—Ä–µ—à–∏—Ç—å –£–ª—å—è–Ω–æ–≤—Å–∫ (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç 3)
while read ip; do
    [[ "$ip" =~ ^# ]] && continue
    ufw allow from $ip to any port 8080 proto tcp comment "Ulyanovsk IP"
done < /etc/tinyproxy/ulyanovsk_ips.txt

# 4. –†–∞–∑—Ä–µ—à–∏—Ç—å –≤—Å—é –†–§ (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç 4)
# –ò—Å–ø–æ–ª—å–∑—É–µ–º –∏–∑–≤–µ—Å—Ç–Ω—ã–µ –¥–∏–∞–ø–∞–∑–æ–Ω—ã –†–§ (–æ—Å–Ω–æ–≤–Ω—ã–µ)
ufw allow from 5.8.0.0/13 to any port 8080 proto tcp comment "RU IP range 1"
ufw allow from 31.131.0.0/16 to any port 8080 proto tcp comment "RU IP range 2"
ufw allow from 37.139.0.0/16 to any port 8080 proto tcp comment "RU IP range 3"
ufw allow from 46.17.40.0/21 to any port 8080 proto tcp comment "RU IP range 4"
ufw allow from 46.21.96.0/19 to any port 8080 proto tcp comment "RU IP range 5"
ufw allow from 46.232.0.0/16 to any port 8080 proto tcp comment "RU IP range 6"
ufw allow from 77.88.0.0/18 to any port 8080 proto tcp comment "RU IP range 7"
ufw allow from 79.133.0.0/16 to any port 8080 proto tcp comment "RU IP range 8"
ufw allow from 84.201.128.0/18 to any port 8080 proto tcp comment "RU IP range 9"
ufw allow from 87.250.0.0/16 to any port 8080 proto tcp comment "RU IP range 10"
ufw allow from 93.158.134.0/24 to any port 8080 proto tcp comment "RU IP range 11"
ufw allow from 95.163.0.0/16 to any port 8080 proto tcp comment "RU IP range 12"
ufw allow from 178.154.128.0/17 to any port 8080 proto tcp comment "RU IP range 13"
ufw allow from 185.32.248.0/22 to any port 8080 proto tcp comment "RU IP range 14"
ufw allow from 213.180.192.0/19 to any port 8080 proto tcp comment "RU IP range 15"

# 5. –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ—Ö –æ—Å—Ç–∞–ª—å–Ω—ã—Ö
ufw deny 8080/tcp

# 6. –ü—Ä–∏–º–µ–Ω–∏—Ç—å –ø—Ä–∞–≤–∏–ª–∞
ufw reload
```

**‚ö†Ô∏è –í–Ω–∏–º–∞–Ω–∏–µ:** –°–ø–∏—Å–æ–∫ IP –¥–∏–∞–ø–∞–∑–æ–Ω–æ–≤ –†–§ –Ω–µ–ø–æ–ª–Ω—ã–π. –î–ª—è —Ç–æ—á–Ω–æ–≥–æ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –Ω—É–∂–Ω–∞ GeoIP –±–∞–∑–∞.

---

### –®–ê–ì 3: –û–≥—Ä–∞–Ω–∏—á–∏—Ç—å –¥–æ 20 –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π

```bash
# –í /etc/tinyproxy/tinyproxy.conf —É–∂–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å:
# MaxClients 20

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å:
grep MaxClients /etc/tinyproxy/tinyproxy.conf

# –ï—Å–ª–∏ –Ω–µ—Ç, –¥–æ–±–∞–≤–∏—Ç—å:
echo "MaxClients 20" >> /etc/tinyproxy/tinyproxy.conf
systemctl restart tinyproxy
```

---

## ‚úÖ –í–ê–†–ò–ê–ù–¢ 2: –ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π (—á–µ—Ä–µ–∑ GeoIP –±–∞–∑—ã)

### –®–ê–ì 1: –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å GeoIP –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

```bash
# –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —É—Ç–∏–ª–∏—Ç—ã
apt-get update
apt-get install -y geoip-bin geoip-database libgeoip1

# –°–∫–∞—á–∞—Ç—å –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ GeoIP –±–∞–∑—ã (MaxMind GeoLite2)
cd /tmp
wget https://github.com/P3TERX/GeoLite.mmdb/raw/download/GeoLite2-City.mmdb
wget https://github.com/P3TERX/GeoLite.mmdb/raw/download/GeoLite2-Country.mmdb

# –ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –≤ —Å–∏—Å—Ç–µ–º–Ω—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
mkdir -p /usr/share/GeoIP
mv GeoLite2-*.mmdb /usr/share/GeoIP/
```

---

### –®–ê–ì 2: –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å mmdblookup (–¥–ª—è —Ä–∞–±–æ—Ç—ã —Å GeoIP2)

```bash
# –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å mmdb-tools
apt-get install -y mmdb-bin

# –ò–ª–∏ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏–∑ –∏—Å—Ö–æ–¥–Ω–∏–∫–æ–≤
apt-get install -y build-essential libmaxminddb-dev
cd /tmp
git clone https://github.com/maxmind/libmaxminddb.git
cd libmaxminddb
./bootstrap
./configure
make
make install
ldconfig
```

---

### –®–ê–ì 3: –°–æ–∑–¥–∞—Ç—å —Å–∫—Ä–∏–ø—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ GeoIP

```bash
cat > /usr/local/bin/check-geoip.sh << 'EOF'
#!/bin/bash
IP=$1

if [ -z "$IP" ]; then
    echo "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: check-geoip.sh <IP_ADDRESS>"
    exit 1
fi

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç—Ä–∞–Ω—É
COUNTRY=$(mmdblookup -f /usr/share/GeoIP/GeoLite2-Country.mmdb -i $IP country iso_code 2>/dev/null | grep -oP '"\K[^"]+')

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≥–æ—Ä–æ–¥
CITY=$(mmdblookup -f /usr/share/GeoIP/GeoLite2-City.mmdb -i $IP city names en 2>/dev/null | grep -oP '"\K[^"]+')

echo "IP: $IP"
echo "–°—Ç—Ä–∞–Ω–∞: $COUNTRY"
echo "–ì–æ—Ä–æ–¥: $CITY"
EOF

chmod +x /usr/local/bin/check-geoip.sh
```

---

### –®–ê–ì 4: –°–æ–∑–¥–∞—Ç—å —Å–∫—Ä–∏–ø—Ç –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø—Ä–∞–≤–∏–ª

```bash
cat > /usr/local/bin/allow-by-geoip.sh << 'EOF'
#!/bin/bash
# –°–∫—Ä–∏–ø—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ IP –∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤ whitelist

IP=$1

if [ -z "$IP" ]; then
    echo "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: allow-by-geoip.sh <IP_ADDRESS>"
    exit 1
fi

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç—Ä–∞–Ω—É
COUNTRY=$(mmdblookup -f /usr/share/GeoIP/GeoLite2-Country.mmdb -i $IP country iso_code 2>/dev/null | grep -oP '"\K[^"]+')

if [ "$COUNTRY" != "RU" ]; then
    echo "‚ùå IP $IP –Ω–µ –∏–∑ –†–§, –¥–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω"
    exit 1
fi

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≥–æ—Ä–æ–¥
CITY=$(mmdblookup -f /usr/share/GeoIP/GeoLite2-City.mmdb -i $IP city names en 2>/dev/null | grep -oP '"\K[^"]+')

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ IP –Ø–Ω–¥–µ–∫—Å–∞
# (–º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –ø–æ –∏–∑–≤–µ—Å—Ç–Ω—ã–º –¥–∏–∞–ø–∞–∑–æ–Ω–∞–º)

# –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–∞–≤–∏–ª–æ UFW
if [ "$CITY" == "Tyumen" ] || [ "$CITY" == "–¢—é–º–µ–Ω—å" ]; then
    ufw allow from $IP to any port 8080 proto tcp comment "Tyumen: $CITY"
    echo "‚úÖ –†–∞–∑—Ä–µ—à–µ–Ω –¥–æ—Å—Ç—É–ø –¥–ª—è –¢—é–º–µ–Ω–∏: $IP"
elif [ "$CITY" == "Ulyanovsk" ] || [ "$CITY" == "–£–ª—å—è–Ω–æ–≤—Å–∫" ]; then
    ufw allow from $IP to any port 8080 proto tcp comment "Ulyanovsk: $CITY"
    echo "‚úÖ –†–∞–∑—Ä–µ—à–µ–Ω –¥–æ—Å—Ç—É–ø –¥–ª—è –£–ª—å—è–Ω–æ–≤—Å–∫–∞: $IP"
else
    ufw allow from $IP to any port 8080 proto tcp comment "RU: $CITY"
    echo "‚úÖ –†–∞–∑—Ä–µ—à–µ–Ω –¥–æ—Å—Ç—É–ø –¥–ª—è –†–§: $IP ($CITY)"
fi

ufw reload
EOF

chmod +x /usr/local/bin/allow-by-geoip.sh
```

---

### –®–ê–ì 5: –ù–∞—Å—Ç—Ä–æ–∏—Ç—å fail2ban —Å GeoIP —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π

```bash
cat > /etc/fail2ban/filter.d/tinyproxy-geoip.conf << 'EOF'
[Definition]
# –§–∏–ª—å—Ç—Ä –¥–ª—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –Ω–µ-–†–§ IP
failregex = ^.*Connection from <HOST>.*$
ignoreregex =
EOF

cat >> /etc/fail2ban/jail.d/tinyproxy.conf << 'EOF'

[tinyproxy-geoip]
enabled = true
port = 8080
filter = tinyproxy-geoip
logpath = /var/log/tinyproxy/tinyproxy.log
maxretry = 1
bantime = 86400
findtime = 60
action = iptables[name=TinyProxy, port=8080, protocol=tcp]
EOF

systemctl restart fail2ban
```

---

## üîß –ì–∏–±—Ä–∏–¥–Ω—ã–π –ø–æ–¥—Ö–æ–¥ (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)

**–°–æ—á–µ—Ç–∞–Ω–∏–µ –æ–±–æ–∏—Ö –º–µ—Ç–æ–¥–æ–≤:**

1. **–Ø–Ω–¥–µ–∫—Å IP** - —á–µ—Ä–µ–∑ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π —Å–ø–∏—Å–æ–∫ (–±—ã—Å—Ç—Ä–æ, —Ç–æ—á–Ω–æ)
2. **–ì–æ—Ä–æ–¥–∞ –†–§** - —á–µ—Ä–µ–∑ GeoIP –ø—Ä–æ–≤–µ—Ä–∫—É –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏
3. **–í—Å—è –†–§** - —á–µ—Ä–µ–∑ GeoIP –ø—Ä–æ–≤–µ—Ä–∫—É
4. **–û—Å—Ç–∞–ª—å–Ω—ã–µ** - –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏

---

## üìù –ü–æ–ª–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ (–≥–∏–±—Ä–∏–¥–Ω—ã–π –ø–æ–¥—Ö–æ–¥)

### –®–ê–ì 1: –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å GeoIP –±–∞–∑—ã

```bash
apt-get update
apt-get install -y geoip-bin geoip-database libgeoip1 mmdb-bin

# –°–∫–∞—á–∞—Ç—å –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –±–∞–∑—ã
cd /tmp
wget -O GeoLite2-City.mmdb https://github.com/P3TERX/GeoLite.mmdb/raw/download/GeoLite2-City.mmdb
wget -O GeoLite2-Country.mmdb https://github.com/P3TERX/GeoLite.mmdb/raw/download/GeoLite2-Country.mmdb

mkdir -p /usr/share/GeoIP
mv GeoLite2-*.mmdb /usr/share/GeoIP/
```

---

### –®–ê–ì 2: –°–æ–∑–¥–∞—Ç—å —Å–ø–∏—Å–æ–∫ IP –Ø–Ω–¥–µ–∫—Å–∞

```bash
cat > /etc/tinyproxy/yandex_ips.txt << 'EOF'
# –û—Å–Ω–æ–≤–Ω—ã–µ IP –¥–∏–∞–ø–∞–∑–æ–Ω—ã –Ø–Ω–¥–µ–∫—Å–∞
5.45.192.0/18
5.45.250.0/23
37.9.64.0/18
37.140.128.0/18
77.88.0.0/18
87.250.224.0/19
93.158.134.0/24
95.163.0.0/16
141.8.128.0/18
178.154.128.0/17
185.32.248.0/22
213.180.192.0/19
EOF
```

---

### –®–ê–ì 3: –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–∞–≤–∏–ª–∞ UFW –¥–ª—è –Ø–Ω–¥–µ–∫—Å–∞

```bash
# –†–∞–∑—Ä–µ—à–∏—Ç—å –Ø–Ω–¥–µ–∫—Å (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç 1)
while read ip; do
    [[ "$ip" =~ ^# ]] && continue
    ufw allow from $ip to any port 8080 proto tcp comment "Yandex IP"
done < /etc/tinyproxy/yandex_ips.txt
```

---

### –®–ê–ì 4: –°–æ–∑–¥–∞—Ç—å —Å–∫—Ä–∏–ø—Ç –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –†–§ IP

```bash
cat > /usr/local/bin/auto-allow-ru-ip.sh << 'EOF'
#!/bin/bash
# –°–∫—Ä–∏–ø—Ç –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –¥–æ—Å—Ç—É–ø–∞ –¥–ª—è –†–§ IP

LOG_FILE="/var/log/tinyproxy/tinyproxy.log"
GEOIP_CITY="/usr/share/GeoIP/GeoLite2-City.mmdb"
GEOIP_COUNTRY="/usr/share/GeoIP/GeoLite2-Country.mmdb"

# –§—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ IP
check_and_allow_ip() {
    local IP=$1
    
    # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç—Ä–∞–Ω—É
    local COUNTRY=$(mmdblookup -f $GEOIP_COUNTRY -i $IP country iso_code 2>/dev/null | grep -oP '"\K[^"]+')
    
    if [ "$COUNTRY" != "RU" ]; then
        return 1
    fi
    
    # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≥–æ—Ä–æ–¥
    local CITY=$(mmdblookup -f $GEOIP_CITY -i $IP city names en 2>/dev/null | grep -oP '"\K[^"]+')
    
    # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω –ª–∏ —É–∂–µ
    if ufw status | grep -q "$IP.*8080"; then
        return 0
    fi
    
    # –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–∞–≤–∏–ª–æ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –≥–æ—Ä–æ–¥–∞
    if [ "$CITY" == "Tyumen" ] || [ "$CITY" == "–¢—é–º–µ–Ω—å" ]; then
        ufw allow from $IP to any port 8080 proto tcp comment "Tyumen: $CITY"
        echo "$(date): ‚úÖ –†–∞–∑—Ä–µ—à–µ–Ω –¥–æ—Å—Ç—É–ø –¥–ª—è –¢—é–º–µ–Ω–∏: $IP" >> /var/log/geoip-allow.log
    elif [ "$CITY" == "Ulyanovsk" ] || [ "$CITY" == "–£–ª—å—è–Ω–æ–≤—Å–∫" ]; then
        ufw allow from $IP to any port 8080 proto tcp comment "Ulyanovsk: $CITY"
        echo "$(date): ‚úÖ –†–∞–∑—Ä–µ—à–µ–Ω –¥–æ—Å—Ç—É–ø –¥–ª—è –£–ª—å—è–Ω–æ–≤—Å–∫–∞: $IP" >> /var/log/geoip-allow.log
    else
        ufw allow from $IP to any port 8080 proto tcp comment "RU: $CITY"
        echo "$(date): ‚úÖ –†–∞–∑—Ä–µ—à–µ–Ω –¥–æ—Å—Ç—É–ø –¥–ª—è –†–§: $IP ($CITY)" >> /var/log/geoip-allow.log
    fi
    
    ufw reload > /dev/null 2>&1
    return 0
}

# –ú–æ–Ω–∏—Ç–æ—Ä–∏—Ç—å –ª–æ–≥–∏ –∏ –¥–æ–±–∞–≤–ª—è—Ç—å –Ω–æ–≤—ã–µ IP
tail -f $LOG_FILE | while read line; do
    # –ò–∑–≤–ª–µ—á—å IP –∏–∑ –ª–æ–≥–∞
    IP=$(echo "$line" | grep -oP 'from \K[0-9.]+' | head -1)
    
    if [ -n "$IP" ]; then
        check_and_allow_ip "$IP"
    fi
done
EOF

chmod +x /usr/local/bin/auto-allow-ru-ip.sh
```

---

### –®–ê–ì 5: –ù–∞—Å—Ç—Ä–æ–∏—Ç—å MaxClients = 20

```bash
# –£–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ MaxClients = 20
sed -i 's/^MaxClients.*/MaxClients 20/' /etc/tinyproxy/tinyproxy.conf
grep -q "^MaxClients" /etc/tinyproxy/tinyproxy.conf || echo "MaxClients 20" >> /etc/tinyproxy/tinyproxy.conf
systemctl restart tinyproxy
```

---

### –®–ê–ì 6: –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ—Ö –æ—Å—Ç–∞–ª—å–Ω—ã—Ö

```bash
ufw deny 8080/tcp
ufw reload
```

---

## üéØ –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã –¥–æ—Å—Ç—É–ø–∞

–ü—Ä–∞–≤–∏–ª–∞ UFW –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è **–ø–æ –ø–æ—Ä—è–¥–∫—É**, –ø–µ—Ä–≤–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è:

1. **–Ø–Ω–¥–µ–∫—Å IP** (–∏–∑ —Ñ–∞–π–ª–∞ yandex_ips.txt) - ‚úÖ –†–∞–∑—Ä–µ—à–µ–Ω
2. **–¢—é–º–µ–Ω—å** (–æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è —á–µ—Ä–µ–∑ GeoIP) - ‚úÖ –†–∞–∑—Ä–µ—à–µ–Ω
3. **–£–ª—å—è–Ω–æ–≤—Å–∫** (–æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è —á–µ—Ä–µ–∑ GeoIP) - ‚úÖ –†–∞–∑—Ä–µ—à–µ–Ω
4. **–î—Ä—É–≥–∏–µ –≥–æ—Ä–æ–¥–∞ –†–§** (–æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è —á–µ—Ä–µ–∑ GeoIP) - ‚úÖ –†–∞–∑—Ä–µ—à–µ–Ω
5. **–í—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ** - ‚ùå –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω (ufw deny)

**–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ:** –ú–∞–∫—Å–∏–º—É–º 20 –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π (MaxClients)

---

## üìä –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã

### –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–∞–≤–∏–ª–∞ UFW:
```bash
ufw status | grep 8080
```

### –ü—Ä–æ–≤–µ—Ä–∏—Ç—å GeoIP –¥–ª—è IP:
```bash
check-geoip.sh 5.45.192.1
```

### –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π:
```bash
ss -tn | grep :8080 | wc -l
```

### –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏:
```bash
tail -f /var/log/geoip-allow.log
```

---

## ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è

1. **GeoIP –±–∞–∑—ã –Ω—É–∂–Ω–æ –æ–±–Ω–æ–≤–ª—è—Ç—å** —Ä–∞–∑ –≤ –º–µ—Å—è—Ü (IP –¥–∏–∞–ø–∞–∑–æ–Ω—ã –º–µ–Ω—è—é—Ç—Å—è)
2. **–¢–æ—á–Ω–æ—Å—Ç—å GeoIP** –Ω–µ 100% (–æ—Å–æ–±–µ–Ω–Ω–æ –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤)
3. **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:** GeoIP –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ–±–∞–≤–ª—è–µ—Ç –Ω–µ–±–æ–ª—å—à—É—é –∑–∞–¥–µ—Ä–∂–∫—É
4. **–î–ª—è —Ç–æ—á–Ω–æ–≥–æ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –≥–æ—Ä–æ–¥–æ–≤** –Ω—É–∂–Ω—ã –ø–ª–∞—Ç–Ω—ã–µ GeoIP –±–∞–∑—ã (MaxMind GeoIP2)

---

## üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ GeoIP –±–∞–∑

```bash
# –°–æ–∑–¥–∞—Ç—å —Å–∫—Ä–∏–ø—Ç –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
cat > /usr/local/bin/update-geoip.sh << 'EOF'
#!/bin/bash
cd /tmp
wget -O GeoLite2-City.mmdb https://github.com/P3TERX/GeoLite.mmdb/raw/download/GeoLite2-City.mmdb
wget -O GeoLite2-Country.mmdb https://github.com/P3TERX/GeoLite.mmdb/raw/download/GeoLite2-Country.mmdb
mv GeoLite2-*.mmdb /usr/share/GeoIP/
echo "$(date): GeoIP –±–∞–∑—ã –æ–±–Ω–æ–≤–ª–µ–Ω—ã" >> /var/log/geoip-update.log
EOF

chmod +x /usr/local/bin/update-geoip.sh

# –î–æ–±–∞–≤–∏—Ç—å –≤ crontab (—Ä–∞–∑ –≤ –º–µ—Å—è—Ü)
(crontab -l 2>/dev/null; echo "0 0 1 * * /usr/local/bin/update-geoip.sh") | crontab -
```

---

## üìù –†–µ–∑—é–º–µ

**–ß—Ç–æ –ø–æ–ª—É—á–∏—Ç—Å—è:**
- ‚úÖ –Ø–Ω–¥–µ–∫—Å IP –∏–º–µ—é—Ç –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç (—Ä–∞–∑—Ä–µ—à–µ–Ω—ã —Å—Ä–∞–∑—É)
- ‚úÖ –¢—é–º–µ–Ω—å, –£–ª—å—è–Ω–æ–≤—Å–∫, –¥—Ä—É–≥–∏–µ –≥–æ—Ä–æ–¥–∞ –†–§ —Ä–∞–∑—Ä–µ—à–µ–Ω—ã (—á–µ—Ä–µ–∑ GeoIP)
- ‚úÖ –í—Å–µ –Ω–µ-–†–§ IP –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã
- ‚úÖ –ú–∞–∫—Å–∏–º—É–º 20 –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –ù–∞—á–Ω–∏—Ç–µ —Å –í–∞—Ä–∏–∞–Ω—Ç–∞ 1 (–ø—Ä–æ—Å—Ç–æ–π), –µ—Å–ª–∏ –Ω—É–∂–Ω–∞ –±–æ–ª–µ–µ —Ç–æ—á–Ω–∞—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è - –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç–µ –Ω–∞ –í–∞—Ä–∏–∞–Ω—Ç 2 (GeoIP).

---

**–í–æ–ø—Ä–æ—Å—ã?** –°–ø—Ä–æ—Å–∏—Ç–µ, –µ—Å–ª–∏ —á—Ç–æ-—Ç–æ –Ω–µ–ø–æ–Ω—è—Ç–Ω–æ!
