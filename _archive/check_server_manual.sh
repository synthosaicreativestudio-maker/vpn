#!/bin/bash

# –†—É—á–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞ (–∑–∞–ø—É—Å–∫–∞—Ç—å –ø–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è SSH –¥–æ—Å—Ç—É–ø–∞)
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: ./check_server_manual.sh

SERVER_IP="37.1.212.51"

echo "=========================================="
echo "üîç –†–£–ß–ù–ê–Ø –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê VPN –°–ï–†–í–ï–†–ê"
echo "=========================================="
echo ""
echo "–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä—É: $SERVER_IP"
echo ""

# –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∫–æ–º–∞–Ω–¥ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
ssh root@$SERVER_IP << 'EOF'

echo "1Ô∏è‚É£  –ü—Ä–æ–≤–µ—Ä–∫–∞ Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤:"
echo "----------------------------------------"
docker ps | grep marzban || echo "‚ùå –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω"
echo ""

echo "2Ô∏è‚É£  –í—Å–µ Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã:"
echo "----------------------------------------"
docker ps -a
echo ""

echo "3Ô∏è‚É£  –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Ä—Ç–∞ 443:"
echo "----------------------------------------"
netstat -tlnp | grep 443 || ss -tlnp | grep 443 || echo "‚ùå –ü–æ—Ä—Ç 443 –Ω–µ —Å–ª—É—à–∞–µ—Ç—Å—è"
echo ""

echo "4Ô∏è‚É£  –°—Ç–∞—Ç—É—Å Docker —Å–µ—Ä–≤–∏—Å–∞:"
echo "----------------------------------------"
systemctl status docker --no-pager | head -5
echo ""

echo "5Ô∏è‚É£  –°—Ç–∞—Ç—É—Å —Ñ–∞–π—Ä–≤–æ–ª–∞ (UFW):"
echo "----------------------------------------"
ufw status
echo ""

echo "6Ô∏è‚É£  –ü–æ—Å–ª–µ–¥–Ω–∏–µ –ª–æ–≥–∏ Marzban (30 —Å—Ç—Ä–æ–∫):"
echo "----------------------------------------"
docker logs marzban-marzban-1 --tail 30 2>&1 || echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –ª–æ–≥–∏"
echo ""

echo "7Ô∏è‚É£  –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ VLESS Reality:"
echo "----------------------------------------"
if [ -f /var/lib/marzban/xray_config.json ]; then
    if grep -q "VLESS-Reality" /var/lib/marzban/xray_config.json; then
        echo "‚úÖ VLESS Reality –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –Ω–∞–π–¥–µ–Ω–∞"
        echo "–§—Ä–∞–≥–º–µ–Ω—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏:"
        cat /var/lib/marzban/xray_config.json | python3 -m json.tool 2>/dev/null | grep -A 15 "VLESS-Reality" | head -20
    else
        echo "‚ùå VLESS Reality –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"
    fi
else
    echo "‚ùå –§–∞–π–ª –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"
fi
echo ""

echo "8Ô∏è‚É£  –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ—Ü–µ—Å—Å–∞ xray:"
echo "----------------------------------------"
ps aux | grep xray | grep -v grep || echo "‚ùå –ü—Ä–æ—Ü–µ—Å—Å xray –Ω–µ –Ω–∞–π–¥–µ–Ω"
echo ""

echo "=========================================="
echo "‚úÖ –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞"
echo "=========================================="

EOF
